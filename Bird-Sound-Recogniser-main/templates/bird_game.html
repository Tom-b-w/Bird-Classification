<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>鸟鸣连线游戏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: url("{{ url_for('static', filename='images/bg_main.jpg') }}") no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }



        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: transparent;
            overflow: visible;
        }

        .header {
            background: transparent;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 3px 3px 15px rgba(0, 0, 0, 0.8);
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.2em;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.8);
            margin-bottom: 20px;
        }

        .score-board {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            position: relative;
            z-index: 1;
        }

        .score-item {
            background: transparent;
            color: white;
            padding: 12px 25px;
            font-size: 1.1em;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.8);
        }

        .score-item div:first-child {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .game-controls {
            padding: 20px;
            text-align: center;
            background: transparent;
        }

        .btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            background: linear-gradient(135deg, #45a049 0%, #388e3c 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
        }

        .btn:disabled {
            background: linear-gradient(135deg, #bdbdbd 0%, #9e9e9e 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .btn.home-btn {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
        }

        .btn.home-btn:hover {
            background: linear-gradient(135deg, #F57C00 0%, #E65100 100%);
            box-shadow: 0 8px 25px rgba(255, 152, 0, 0.4);
        }

        .game-area {
            padding: 30px;
            display: none;
        }

        .game-area.active {
            display: block;
        }

        .game-content {
            display: grid;
            grid-template-columns: 1fr 100px 1fr;
            gap: 30px;
            align-items: start;
        }

        .sounds-section, .birds-section {
            background: transparent;
            padding: 25px;
        }

        .section-title {
            font-size: 1.8em;
            margin-bottom: 25px;
            text-align: center;
            color: white;
            text-shadow: 3px 3px 15px rgba(0, 0, 0, 0.8);
            font-weight: 700;
            position: relative;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.8), transparent);
            border-radius: 2px;
        }

        .sound-item, .bird-item {
            padding: 18px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
            border-radius: 15px;
        }

        .sound-item {
            background: rgba(33, 150, 243, 0.15);
            backdrop-filter: blur(8px);
            border: 2px solid #2196F3;
        }

        .bird-item {
            background: rgba(169, 169, 169, 0.2);  /* 浅灰色背景，透明度为 0.2 */
            backdrop-filter: blur(8px);  /* 保持模糊效果 */
            border: 2px solid #808080;  /* 灰色边框 */
        }

        .sound-item::before, .bird-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }

        .sound-item:hover::before, .bird-item:hover::before {
            left: 100%;
        }

        .sound-item:hover, .bird-item:hover {
            transform: translateY(-3px) scale(1.02);
        }

        .sound-item:hover {
            background: rgba(33, 150, 243, 0.25);
            border-color: #1976D2;
        }

        .bird-item:hover {
            background-color: #76c7c0;  /* 温暖的浅绿色背景 */
            border-color: #808080;  /* 标准灰色边框 */
        }


        .sound-item.selected {
            background: rgba(33, 150, 243, 0.4);
            border-color: #0D47A1;
            transform: translateY(-2px) scale(1.03);
        }

        .bird-item.selected {
            background: rgba(76, 175, 80, 0.4);
            border-color: #1B5E20;
            transform: translateY(-2px) scale(1.03);
        }

        .sound-item.matched {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4CAF50;
            opacity: 0.7;
            pointer-events: none;
            transform: scale(0.98);
        }

        .bird-item.matched {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4CAF50;
            opacity: 0.7;
            pointer-events: none;
            transform: scale(0.98);
        }

        .sound-item.wrong {
            background: rgba(244, 67, 54, 0.3);
            border-color: #F44336;
            animation: shake 0.6s ease-in-out;
        }

        .bird-item.wrong {
            background: rgba(244, 67, 54, 0.3);
            border-color: #F44336;
            animation: shake 0.6s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .play-btn {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }

        .play-btn:hover {
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }

        .play-btn:active {
            transform: scale(0.95);
        }

        .bird-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .bird-name {
            font-size: 1.1em;
            font-weight: bold;
            color: white;
            text-align: center;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8);
        }

        .sound-item div:last-child {
            color: white;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8);
            font-weight: 600;
            font-size: 1.1em;
        }

        .connection-area {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            padding: 20px;
        }

        .connection-area div {
            font-size: 2.5em;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 2px 15px rgba(0, 0, 0, 0.8);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.1);
                opacity: 1;
            }
        }

        .connection-line {
            position: absolute;
            height: 2px;
            background: #4CAF50;
            transform-origin: left center;
            opacity: 0.8;
            z-index: 1;
        }

        .game-result {
            text-align: center;
            padding: 30px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin-top: 20px;
            display: none;
        }

        .game-result.show {
            display: block;
        }

        .result-title {
            font-size: 2em;
            color: white;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.8);
            margin-bottom: 15px;
        }

        .result-score {
            font-size: 1.5em;
            color: white;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.8);
            margin-bottom: 20px;
        }

        .success-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .success-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .success-modal-content {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: scale(0.7);
            transition: transform 0.3s ease;
            max-width: 400px;
            margin: 20px;
        }

        .success-modal.show .success-modal-content {
            transform: scale(1);
        }

        .success-modal h2 {
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
        }

        .success-modal p {
            font-size: 1.3em;
            margin-bottom: 30px;
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.3);
        }

        .success-modal .btn {
            margin: 0 10px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: white;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.8);
        }

        .error-message {
            background: rgba(244, 67, 54, 0.2);
            backdrop-filter: blur(8px);
            color: white;
            padding: 15px;
            border-radius: 15px;
            margin: 20px;
            text-align: center;
            display: none;
            text-shadow: 1px 1px 5px rgba(0, 0, 0, 0.8);
        }

        .instructions {
            background: white;
            padding: 20px;
            margin: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .instructions h3 {
            color: #2E7D32;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .instructions ul {
            color: #333;
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
            font-size: 1em;
        }

        @media (max-width: 768px) {
            .game-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .connection-area {
                display: none;
            }

            .score-board {
                flex-direction: column;
                gap: 10px;
            }

            .btn {
                display: block;
                margin: 10px auto;
                width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🐦 鸟鸣连线游戏</h1>
            <p>听声识鸟，连线匹配！</p>
            <div class="score-board">
                <div class="score-item">
                    <div>得分</div>
                    <div id="score">0</div>
                </div>
                <div class="score-item">
                    <div>已匹配</div>
                    <div id="matches">0/0</div>
                </div>
            </div>
        </div>

        <div class="instructions">
            <h3>游戏规则：</h3>
            <ul>
                <li>点击左侧的播放按钮听鸟鸣声</li>
                <li>选择对应的鸟类图片进行连线</li>
                <li>正确匹配得10分，错误匹配无得分</li>
                <li>完成所有匹配即可过关！</li>
            </ul>
        </div>

        <div class="game-controls">
            <button class="btn home-btn" onclick="window.location.href='/welcome'">🏠 返回首页</button>
            <button class="btn" id="startBtn">开始游戏</button>
            <button class="btn" id="resetBtn" disabled>重新开始</button>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="game-area" id="gameArea">
            <div class="loading" id="loading">正在加载游戏数据...</div>

            <div class="game-content" id="gameContent" style="display: none;">
                <div class="sounds-section">
                    <div class="section-title">🔊 鸟鸣声音</div>
                    <div id="soundsList"></div>
                </div>

                <div class="connection-area" id="connectionArea">
                    <div style="font-size: 2em; color: #4CAF50;">↔</div>
                </div>

                <div class="birds-section">
                    <div class="section-title">🐦 鸟类图片</div>
                    <div id="birdsList"></div>
                </div>
            </div>

            <div class="game-result" id="gameResult">
                <div class="result-title">🎉 恭喜完成！</div>
                <div class="result-score" id="finalScore"></div>
                <button class="btn" onclick="startNewGame()">再玩一次</button>
            </div>
        </div>
    </div>

    <!-- 成功弹窗 -->
    <div class="success-modal" id="successModal">
        <div class="success-modal-content">
            <h2>🎉 恭喜！</h2>
            <p>闯关成功！</p>
            <p>您成功匹配了所有的鸟鸣声！</p>
            <button class="btn" onclick="closeSuccessModal()">继续</button>
            <button class="btn" onclick="startNewGame(); closeSuccessModal();">再玩一次</button>
        </div>
    </div>

    <script>
        // 完整的鸟类数据
        const BIRD_GAME_DATA = {
            '灰雁': {
                'description': '灰雁是一种大型水鸟，主要栖息在湿地和湖泊中。',
                'image': 'images/gray_geese.png',
                'sound': 'sounds/gray_geese.wav'
            },
            '大天鹅': {
                'description': '大天鹅是北半球较大的水鸟，以其优美的姿态著称。',
                'image': 'images/swan.png',
                'sound': 'sounds/swan.wav'
            },
            '绿头鸭': {
                'description': '绿头鸭是常见的水鸟，雄性头部呈亮绿色，栖息在湖泊和湿地。',
                'image': 'images/mallard_duck.png',
                'sound': 'sounds/mallard_duck.wav'
            },
            '绿翅鸭': {
                'description': '绿翅鸭是一种栖息在湿地中的小型水鸟，雄性具有独特的绿色翅膀。',
                'image': 'images/green_winged_duck.png',
                'sound': 'sounds/green_winged_duck.wav'
            },
            '灰山鹑': {
                'description': '灰山鹑栖息在山地和干草原，是一种体型较小的鸟类。',
                'image': 'images/grey_partridge.png',
                'sound': 'sounds/grey_partridge.wav'
            },
            '西鹌鹑': {
                'description': '西鹌鹑是一种体型小巧、栖息在草地和灌丛中的鸟类。',
                'image': 'images/western_quail.png',
                'sound': 'sounds/western_quail.wav'
            },
            '雉鸡': {
                'description': '雉鸡是具有艳丽羽毛的鸟类，常见于森林和草原中。',
                'image': 'images/pheasant.png',
                'sound': 'sounds/pheasant.wav'
            },
            '红喉潜鸟': {
                'description': '红喉潜鸟栖息在湖泊和湿地中，具有鲜艳的红色喉部。',
                'image': 'images/red_throated_diver.png',
                'sound': 'sounds/red_throated_diver.wav'
            },
            '苍鹭': {
                'description': '苍鹭是大型水鸟，通常栖息在湿地和沼泽地带，以鱼类为食。',
                'image': 'images/grey_heron.png',
                'sound': 'sounds/grey_heron.wav'
            },
            '普通鸬鹚': {
                'description': '普通鸬鹚是常见的水鸟，栖息在湖泊和河流中，以捕鱼为主。',
                'image': 'images/cormorant.png',
                'sound': 'sounds/cormorant.wav'
            },
            '苍鹰': {
                'description': '苍鹰是一种大型猛禽，主要栖息在森林和山区，捕食其他小型鸟类。',
                'image': 'images/eurasian_hawk.png',
                'sound': 'sounds/eurasian_hawk.wav'
            },
            '欧亚鵟': {
                'description': '欧亚鵟是一种栖息在广阔草原和森林中的猛禽，主要捕食小型哺乳动物。',
                'image': 'images/eurasian_buzzard.png',
                'sound': 'sounds/eurasian_buzzard.wav'
            },
            '西方秧鸡': {
                'description': '西方秧鸡栖息在湿地和农田中，体型较小，动作敏捷。',
                'image': 'images/western_rail.png',
                'sound': 'sounds/western_rail.wav'
            },
            '骨顶鸡': {
                'description': '骨顶鸡栖息在湿地和水草丰富的区域，以水生植物为食。',
                'image': 'images/bonecrest_chicken.png',
                'sound': 'sounds/bonecrest_chicken.wav'
            },
            '黑翅长脚鹬': {
                'description': '黑翅长脚鹬栖息在湿地地区，具有较长的腿部和黑色的翅膀。',
                'image': 'images/black_winged_stilt.png',
                'sound': 'sounds/black_winged_stilt.wav'
            },
            '凤头麦鸡': {
                'description': '凤头麦鸡是一种栖息在草地和农田中的鸟类，拥有显著的头部羽冠。',
                'image': 'images/crested_lark.png',
                'sound': 'sounds/crested_lark.wav'
            },
            '白腰草鹬': {
                'description': '白腰草鹬栖息在湿地和草丛中，拥有鲜明的白色腰部羽毛。',
                'image': 'images/white_winged_snipe.png',
                'sound': 'sounds/white_winged_snipe.wav'
            },
            '红脚鹬': {
                'description': '红脚鹬是一种体型中等的鸟类，栖息在湿地和沼泽地带，常见于迁徙期。',
                'image': 'images/red_legged_snipe.png',
                'sound': 'sounds/red_legged_snipe.wav'
            },
            '林鹬': {
                'description': '林鹬栖息在森林和湿地中，擅长在湿地中觅食。',
                'image': 'images/wood_snipe.png',
                'sound': 'sounds/wood_snipe.wav'
            },
            '麻雀': {
                'description': '麻雀是一种小型鸟类，常见于城市和农田地区，栖息在建筑物附近。',
                'image': 'images/sparrow.jpg',
                'sound': 'sounds/sparrow.wav'
            },
            '八哥': {
                'description': '八哥是一种聪明的鸣禽，擅长模仿人类语言，常见于城市和乡村。',
                'image': 'images/myna.jpg',
                'sound': 'sounds/myna.wav'
            },
            '红头长尾山雀': {
                'description': '红头长尾山雀是一种小型鸟类，具有鲜艳的红色头部，活跃于森林和灌木丛。',
                'image': 'images/red_headed_tit.jpg',
                'sound': 'sounds/red_headed_tit.wav'
            },
            '棕头鸦雀': {
                'description': '棕头鸦雀是一种体型小巧的鸟类，主要分布在森林和灌木丛中。',
                'image': 'images/brown_parrotbill.jpg',
                'sound': 'sounds/brown_parrotbill.wav'
            },
            '黄腹柳莺': {
                'description': '黄腹柳莺是一种小型鸣禽，栖息在森林和灌木丛中，以昆虫为食。',
                'image': 'images/yellow_bellied_warbler.jpg',
                'sound': 'sounds/yellow_bellied_warbler.wav'
            },
            '褐头鹪莺': {
                'description': '褐头鹪莺是一种活跃的鸣禽，以昆虫为食，主要栖息在灌木丛和草地。',
                'image': 'images/brown_warbler.jpg',
                'sound': 'sounds/brown_warbler.wav'
            },
            '白颊噪鹏': {
                'description': '白颊噪鹏是一种生活在森林中的鸟类，以果实和昆虫为食，叫声响亮。',
                'image': 'images/noisy_pitta.jpg',
                'sound': 'sounds/noisy_pitta.wav'
            },
            '白头鹎': {
                'description': '白头鹎是一种常见的鸣禽，喜欢群居，主要分布在城市和农田附近。',
                'image': 'images/light_vented_bulbul.jpg',
                'sound': 'sounds/light_vented_bulbul.wav'
            },
            '矶鹬': {
                'description': '矶鹬是一种小型涉禽，栖息在沿海和淡水湿地，以小型水生动物为食。',
                'image': 'images/sandpiper.jpg',
                'sound': 'sounds/sandpiper.wav'
            },
            '戴胜': {
                'description': '戴胜是一种美丽的鸟类，头顶有醒目的羽冠，主要以昆虫为食。',
                'image': 'images/hoopoe.jpg',
                'sound': 'sounds/hoopoe.wav'
            },
            '小白鹭': {
                'description': '小白鹭是一种常见的涉禽，栖息在湿地和水域边缘，以鱼类和昆虫为食。',
                'image': 'images/little_egret.jpg',
                'sound': 'sounds/little_egret.wav'
            },
            '小白腰雨燕': {
                'description': '小白腰雨燕是一种高速飞行的鸟类，以昆虫为食，常见于空中滑翔。',
                'image': 'images/swift.jpg',
                'sound': 'sounds/swift.wav'
            }
        };

        let gameData = null;
        let selectedSound = null;
        let selectedBird = null;
        let currentAudio = null;
        let currentGameBirds = [];
        let score = 0;
        let matches = 0;

        // 从完整数据中随机选择6个鸟类
        function getRandomBirds(count = 6) {
            const allBirdNames = Object.keys(BIRD_GAME_DATA);
            const shuffled = allBirdNames.sort(() => Math.random() - 0.5);
            return shuffled.slice(0, count);
        }

        // 游戏控制
        document.getElementById('startBtn').addEventListener('click', startNewGame);
        document.getElementById('resetBtn').addEventListener('click', resetGame);

        async function startNewGame() {
            try {
                showLoading(true);
                hideError();

                // 随机选择6个鸟类
                const selectedBirdNames = getRandomBirds(6);
                currentGameBirds = selectedBirdNames.map(name => ({
                    name: name,
                    ...BIRD_GAME_DATA[name]
                }));

                // 模拟API响应格式
                gameData = {
                    birds: currentGameBirds
                };

                score = 0;
                matches = 0;

                setupGame();
                document.getElementById('startBtn').disabled = true;
                document.getElementById('resetBtn').disabled = false;

            } catch (error) {
                showError('开始游戏失败: ' + error.message);
            }
        }

        function setupGame() {
            showLoading(false);
            document.getElementById('gameArea').classList.add('active');
            document.getElementById('gameResult').classList.remove('show');

            const soundsList = document.getElementById('soundsList');
            const birdsList = document.getElementById('birdsList');

            // 清空之前的内容
            soundsList.innerHTML = '';
            birdsList.innerHTML = '';

            // 创建音频列表
            gameData.birds.forEach((bird, index) => {
                const soundItem = createSoundItem(bird, index);
                soundsList.appendChild(soundItem);
            });

            // 创建鸟类图片列表（随机打乱顺序）
            const shuffledBirds = [...gameData.birds].sort(() => Math.random() - 0.5);
            shuffledBirds.forEach((bird, index) => {
                const birdItem = createBirdItem(bird, index);
                birdsList.appendChild(birdItem);
            });

            // 更新得分显示
            updateScore();
        }

        function createSoundItem(bird, index) {
            const soundItem = document.createElement('div');
            soundItem.className = 'sound-item';
            soundItem.dataset.sound = bird.name; // 使用鸟名作为标识
            soundItem.innerHTML = `
                <button class="play-btn" onclick="playSound('${bird.sound}')">▶</button>
                <div>鸟鸣 ${index + 1}</div>
            `;

            soundItem.addEventListener('click', function() {
                if (!this.classList.contains('matched')) {
                    selectSound(this);
                }
            });

            return soundItem;
        }

        function createBirdItem(bird, index) {
            const birdItem = document.createElement('div');
            birdItem.className = 'bird-item';
            birdItem.dataset.bird = bird.name;
            birdItem.innerHTML = `
                <img src="/static/${bird.image}" alt="${bird.name}" class="bird-image"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                     onload="this.nextElementSibling.style.display='none'; this.style.display='block';">
                <div style="display:flex; width:80px; height:80px; background:rgba(227, 242, 253, 0.8); border-radius:10px; align-items:center; justify-content:center; font-size:10px; color:#666; text-align:center; flex-direction:column;">
                    <div style="font-size:20px; margin-bottom:4px;">🐦</div>
                    <div>图片加载中...</div>
                </div>
                <div class="bird-name">${bird.name}</div>
            `;

            birdItem.addEventListener('click', function() {
                if (!this.classList.contains('matched')) {
                    selectBird(this);
                }
            });

            return birdItem;
        }

        function playSound(soundFile) {
            if (currentAudio) {
                currentAudio.pause();
            }

            currentAudio = new Audio(`/static/${soundFile}`);
            currentAudio.play().catch(error => {
                console.error('播放音频失败:', error);
                showError('播放音频失败，请检查文件路径');
            });
        }

        function selectSound(element) {
            // 移除之前的选择
            document.querySelectorAll('.sound-item.selected').forEach(item => {
                item.classList.remove('selected');
            });

            element.classList.add('selected');
            selectedSound = element.dataset.sound;

            // 如果已选择鸟类，尝试匹配
            if (selectedBird) {
                checkMatch();
            }
        }

        function selectBird(element) {
            // 移除之前的选择
            document.querySelectorAll('.bird-item.selected').forEach(item => {
                item.classList.remove('selected');
            });

            element.classList.add('selected');
            selectedBird = element.dataset.bird;

            // 如果已选择音频，尝试匹配
            if (selectedSound) {
                checkMatch();
            }
        }

        async function checkMatch() {
            try {
                // 本地检查匹配
                const isCorrect = selectedSound === selectedBird;

                const soundElement = document.querySelector(`[data-sound="${selectedSound}"]`);
                const birdElement = document.querySelector(`[data-bird="${selectedBird}"]`);

                if (isCorrect) {
                    // 正确匹配
                    soundElement.classList.add('matched');
                    birdElement.classList.add('matched');
                    soundElement.classList.remove('selected');
                    birdElement.classList.remove('selected');

                    score += 10;
                    matches += 1;

                    // 播放成功音效
                    playSuccessSound();

                    // 检查是否完成游戏
                    if (matches === gameData.birds.length) {
                        setTimeout(() => {
                            showSuccessModal();
                        }, 500);
                    }

                } else {
                    // 错误匹配
                    soundElement.classList.add('wrong');
                    birdElement.classList.add('wrong');

                    // 移除错误样式
                    setTimeout(() => {
                        soundElement.classList.remove('wrong', 'selected');
                        birdElement.classList.remove('wrong', 'selected');
                    }, 1000);

                    // 播放错误音效
                    playErrorSound();
                }

                // 重置选择
                selectedSound = null;
                selectedBird = null;

                // 更新得分
                updateScore();

            } catch (error) {
                showError('匹配检查失败: ' + error.message);
            }
        }

        function showSuccessModal() {
            const modal = document.getElementById('successModal');
            modal.classList.add('show');
        }

        function closeSuccessModal() {
            const modal = document.getElementById('successModal');
            modal.classList.remove('show');
        }

        function playSuccessSound() {
            // 创建简单的成功提示音
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
            oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
            oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5

            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        function playErrorSound() {
            // 创建简单的错误提示音
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(150, audioContext.currentTime + 0.2);

            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.4);
        }

        async function updateScore() {
            document.getElementById('score').textContent = score;
            document.getElementById('matches').textContent = `${matches}/${gameData.birds.length}`;
        }

        function showGameResult(finalScore) {
            document.getElementById('finalScore').textContent = `最终得分: ${finalScore} 分`;
            document.getElementById('gameResult').classList.add('show');
        }

        async function resetGame() {
            try {
                // 重置UI
                document.getElementById('gameArea').classList.remove('active');
                document.getElementById('startBtn').disabled = false;
                document.getElementById('resetBtn').disabled = true;
                document.getElementById('score').textContent = '0';
                document.getElementById('matches').textContent = '0/0';

                // 停止当前播放的音频
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }

                // 重置选择
                selectedSound = null;
                selectedBird = null;
                score = 0;
                matches = 0;
                currentGameBirds = [];

                // 关闭成功弹窗
                closeSuccessModal();

            } catch (error) {
                showError('重置游戏失败: ' + error.message);
            }
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            const gameContent = document.getElementById('gameContent');

            if (show) {
                loading.style.display = 'block';
                gameContent.style.display = 'none';
            } else {
                loading.style.display = 'none';
                gameContent.style.display = 'grid';
            }
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';

            // 5秒后自动隐藏
            setTimeout(hideError, 5000);
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('鸟鸣连线游戏已加载');
        });

        // 点击弹窗背景关闭弹窗
        document.getElementById('successModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSuccessModal();
            }
        });
    </script>
</body>
</html>